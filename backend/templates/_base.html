{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KXVV479GJX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KXVV479GJX');
    </script>
    <meta charset="utf-8" />
    <meta name="robots" content="index, follow" />
    <meta
      name="keywords"
      content="eurorack, diy, synthesizer, modular, music, hardware, analog synthesizer, modular synth, electronic music, synth building, sound design, music production, audio gear, circuit design"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width,minimum-scale=1,initial-scale=1"
    />
    <title>{% block title %}Bom Squad{% endblock title %}</title>
    <meta
      name="description"
      content="An inventory and search tool for DIY audio projects and components"
    />
    <meta
      name="author"
      content="https://github.com/PleatherStarfish/bomsquad"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{% static 'images/logo.png' %}"
    />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />

    {% comment %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v2.9.0/dist/cookieconsent.css" />
    {% endcomment %}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/cash-dom/dist/cash.min.js"></script>
    <script>(function(){const{protocol:n,host:o,pathname:t,search:a,hash:h}=window.location;t.endsWith("/")||t.endsWith(".html")||window.location.replace(`${n}//${o}${t}/${a}${h}`)})()</script>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1549230942850511"
     crossorigin="anonymous"></script>
     <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
      />
      <!-- Include Choices.js JavaScript from CDN -->
      <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/motion@11.11.13/dist/motion.js"></script>
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1549230942850511" crossorigin="anonymous"></script>
      <script type="text/javascript">
        (function (f, b) { if (!b.__SV) { var e, g, i, h; window.mixpanel = b; b._i = []; b.init = function (e, f, c) { function g(a, d) { var b = d.split("."); 2 == b.length && ((a = a[b[0]]), (d = b[1])); a[d] = function () { a.push([d].concat(Array.prototype.slice.call(arguments, 0))); }; } var a = b; "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel"); a.people = a.people || []; a.toString = function (a) { var d = "mixpanel"; "mixpanel" !== c && (d += "." + c); a || (d += " (stub)"); return d; }; a.people.toString = function () { return a.toString(1) + ".people (stub)"; }; i = "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split( " "); for (h = 0; h < i.length; h++) g(a, i[h]); var j = "set set_once union unset remove delete".split(" "); a.get_group = function () { function b(c) { d[c] = function () { call2_args = arguments; call2 = [c].concat(Array.prototype.slice.call(call2_args, 0)); a.push([e, call2]); }; } for ( var d = {}, e = ["get_group"].concat( Array.prototype.slice.call(arguments, 0)), c = 0; c < j.length; c++) b(j[c]); return d; }; b._i.push([e, f, c]); }; b.__SV = 1.2; e = f.createElement("script"); e.type = "text/javascript"; e.async = !0; e.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === f.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"; g = f.getElementsByTagName("script")[0]; g.parentNode.insertBefore(e, g); } })(document, window.mixpanel || []);
      </script>
      <script>
        let lastTrackedUrl = null;
  
        function trackPageView(url) {
          if (url !== lastTrackedUrl) {
            lastTrackedUrl = url;
  
            if (window.mixpanel) {
              mixpanel.track("Page View", { page: url });
            }
  
            if (typeof gtag === "function") {
              gtag('event', 'page_view', { page_path: url });
            }
          }
        }
  
        function monitorUrlChanges() {
          const originalPushState = window.history.pushState;
          const originalReplaceState = window.history.replaceState;
  
          function handleUrlChange(url) {
            trackPageView(url || window.location.pathname + window.location.search);
          }
  
          handleUrlChange();
  
          window.history.pushState = function (state, title, url) {
            originalPushState.apply(this, arguments);
            handleUrlChange(url);
          };
  
          window.history.replaceState = function (state, title, url) {
            originalReplaceState.apply(this, arguments);
            handleUrlChange(url);
          };
  
          window.addEventListener("popstate", () => {
            handleUrlChange();
          });
        }
  
        document.addEventListener("DOMContentLoaded", function () {
          mixpanel.init("099a5cb7f4c47e043ee4e55213130e3f", {
            opt_out_tracking_by_default: true,
            ip: true,
          });
  
          monitorUrlChanges();
        });
      </script>

    {% block css %}{% endblock css %}
  </head>

  <body class="min-h-screen">
    <header>{% include "nav.html" %}</header>

    <!-- Cookie Consent -->
    <div id="cookie-consent-banner" class="fixed z-50 hidden max-w-sm transition-all transform bg-gray-600 rounded-lg shadow-lg bottom-4 right-4 sm:bottom-6 sm:right-6">
      <div class="p-6">
          <div class="sm:flex sm:items-start">
              <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                  <h3 class="text-lg font-medium leading-6 text-white">Cookie Consent</h3>
                  <p class="mt-2 text-sm text-white">
                      We use cookies to enhance your browsing experience. Please accept or deny to proceed.
                  </p>
              </div>
          </div>
          <div class="mt-5 sm:mt-4 sm:flex sm:justify-end">
              <button id="allow-cookies" class="inline-flex justify-center w-full px-3 py-2 text-sm font-semibold text-white bg-[#13c3ff] rounded-md shadow-sm hover:bg-blue-500 sm:w-auto">
                  Accept
              </button>
              <button id="deny-cookies" class="inline-flex justify-center w-full px-3 py-2 mt-3 text-sm font-semibold text-gray-700 bg-gray-300 rounded-md shadow-sm hover:bg-gray-400 sm:ml-3 sm:mt-0 sm:w-auto">
                  Deny
              </button>
          </div>
      </div>
    </div>

    <div class="flex flex-col min-h-screen">
      {% with request.path|slice:":5" as path %}
      <div
        class="{% if path == '/user' %}w-screen grow{% else %}mb-12 mt-36 py-8 px-4 md:px-24 lg:px-48 grow{% endif %}"
      >
      {% if path != '/user' and path != '/abou' and path != '/acco' and path != '/faq' and path != '/tos' %}
        <div id="banner" class="hidden {% if path != '/proj' and path != '/comp' %}mb-8{% endif %}">
          <div id="banner" class="flex flex-col w-full gap-4 p-8 rounded-lg bg-[#d4e4ea]" role="alert">
            <div class="flex flex-col w-full">
                <span class="mb-6 text-5xl text-gray-500 font-display">Need seeing your project here?</span>
                <span class="text-gray-500">BOM Squad is an <a class="text-blue-500 hover:text-blue-700" href="https://github.com/PleatherStarfish/bomsquad">open-source</a> tool built and maintained by hobbyists. Subscribe and support the project on <a class="text-blue-500 hover:text-blue-700" href='https://ko-fi.com/bomsquad'>Ko-fi</a> (a Patreon-type social funding platform) and you get to choose the next project/BOM we add, usually within 48 hours!</span>
            </div>
            <div class="flex justify-end w-full gap-2 mt-2 sm:mt-0 sm:w-auto">
              <button id="banner-hide-button" class="w-min flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-400 hover:bg-slate-500 sm:px-3 sm:py-1.5 sm:text-sm">
                Hide
              </button>
              <a href="https://ko-fi.com/bomsquad" target="_blank" rel="noopener noreferrer" class="w-min flex items-center justify-center px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-slate-700 hover:bg-slate-800 sm:px-3 sm:py-1.5 sm:text-sm ml-2 whitespace-nowrap">
                Support BOM Squad
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        {% block content %}{% endblock content %}
      </div>
      {% if path != '/projects' and path != '/user' %}
      <footer>{% include "footer.html" %}</footer>
      {% endif %}
      {% endwith %}
    </div>

    <script data-cookiecategory="analytics" type=\"text/javascript\" defer>\n(function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(\".\");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;\"undefined\"!==typeof c?a=b[c]=[]:c=\"mixpanel\";a.people=a.people||[];a.toString=function(a){var d=\"mixpanel\";\"mixpanel\"!==c&&(d+=\".\"+c);a||(d+=\" (stub)\");return d};a.people.toString=function(){return a.toString(1)+\".people (stub)\"};i=\"disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove\".split(\" \");\nfor(h=0;h<i.length;h++)g(a,i[h]);var j=\"set set_once union unset remove delete\".split(\" \");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=[\"get_group\"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement(\"script\");e.type=\"text/javascript\";e.async=!0;e.src=\"undefined\"!==typeof MIXPANEL_CUSTOM_LIB_URL?\nMIXPANEL_CUSTOM_LIB_URL:\"file:\"===f.location.protocol&&\"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\".match(/^\\/\\//)?\"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\":\"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\";g=f.getElementsByTagName(\"script\")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);\n</script>

    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/mobile_menu.js' %}"></script>

    <script>
      window.addEventListener('load', function() {
        var banner = cash('#banner');
        var hideButton = cash('#banner-hide-button');
        var hiddenTime = localStorage.getItem('bannerHiddenTime');
        var hideDuration = localStorage.getItem('bannerHideDuration');
    
        // Check if banner should be displayed immediately
        if (!hiddenTime || !hideDuration || Date.now() - parseInt(hiddenTime) >= parseInt(hideDuration)) {
          // No hidden time or duration set, or the duration has passed; show the banner
          banner.removeClass('hidden');
        }
    
        // Add a click event listener to the hide button
        hideButton.on('click', function() {
          // Hide the banner
          banner.addClass('hidden');
    
          // Generate a random number of days between 1 and 7
          var randomDays = Math.floor(Math.random() * 4) + 1;
    
          // Convert days to milliseconds for the duration
          var randomDuration = randomDays * 24 * 60 * 60 * 1000;
    
          // Store the current time and random duration in local storage
          localStorage.setItem('bannerHiddenTime', Date.now());
          localStorage.setItem('bannerHideDuration', randomDuration);
        });
      });
    </script>    

    <script>
      setTimeout(function() {
          document.querySelectorAll('.toast').forEach(function(toast) {
              toast.style.opacity = 0;
              setTimeout(function() {
                  toast.remove();
              }, 300);  // Matches the duration of the transition
          });
      }, 5000);  // Toasts will disappear after 5 seconds
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        tippy('[data-tippy-content]', {
          allowHTML: true,
        });
      });
    </script>

    <script>
      $(function () {
        const logo = $("#the_logo");
        const initialScale = 1;
        const shrinkScale = 0.7; // 20% shrink
        const maxScroll = 50; // The scroll amount to reach full shrink
    
        // Set the transform origin to the top
        logo.css("transform-origin", "top");
    
        $(window).on("scroll", () => {
          const scrollY = window.scrollY;
          const scale = Math.max(shrinkScale, initialScale - (scrollY / maxScroll) * (initialScale - shrinkScale));
          logo.css({
            transform: `scale(${scale})`,
            transition: "transform 0.2s ease-out",
          });
        });
      });
    </script>

    <script>
      function updateCurrency(newCurrency) {
        localStorage.setItem("currency", newCurrency);
    
        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
    
        // Update user's default currency on the server if authenticated
        if (isAuthenticated) {
          fetch("{% url 'user_currency' %}", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}", // Include CSRF token for security
            },
            body: JSON.stringify({ default_currency: newCurrency }),
          })
            .then((response) => {
              console.log("Response status:", response.status); // Debug response status
              if (response.ok || response.status === 403) {
                console.log("Reloading page...");
                window.location.replace(window.location.href); // Force reload
              } else {
                console.error("Error updating currency:", response.statusText);
              }
            })
            .catch((error) => {
              console.error("Network error:", error);
              window.location.replace(window.location.href); // Reload on error
            });
        } else {
          console.log("User not authenticated, reloading...");
          window.location.replace(window.location.href); // Reload for unauthenticated users
        }
      }
    
      $(document).ready(function () {
        const currencies = [
          { code: "USD", symbol: "$", name: "US Dollar" },
          { code: "EUR", symbol: "€", name: "Euro" },
          { code: "JPY", symbol: "¥", name: "Japanese Yen" },
          { code: "GBP", symbol: "£", name: "British Pound" },
          { code: "AUD", symbol: "A$", name: "Australian Dollar" },
          { code: "CAD", symbol: "C$", name: "Canadian Dollar" },
          { code: "CHF", symbol: "CHF", name: "Swiss Franc" },
          { code: "CNY", symbol: "¥", name: "Chinese Yuan" },
          { code: "HKD", symbol: "HK$", name: "Hong Kong Dollar" },
          { code: "NZD", symbol: "NZ$", name: "New Zealand Dollar" },
          { code: "SEK", symbol: "kr", name: "Swedish Krona" },
          { code: "KRW", symbol: "₩", name: "South Korean Won" },
          { code: "SGD", symbol: "S$", name: "Singapore Dollar" },
          { code: "NOK", symbol: "kr", name: "Norwegian Krone" },
          { code: "INR", symbol: "₹", name: "Indian Rupee" },
        ];
    
        const currencySelector = $("#currency-selector");
    
        function getDefaultCurrency() {
          const userDefaultCurrency = "{{ request.user.default_currency|default:'' }}";
          const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
          if (isAuthenticated && userDefaultCurrency) {
            return userDefaultCurrency;
          }
          return localStorage.getItem("currency") || "USD";
        }
    
        function populateWithSymbols() {
          currencySelector.empty();
          currencies.forEach((currency) => {
            const option = $("<option>")
              .val(currency.code)
              .text(currency.symbol);
            currencySelector.append(option);
          });
          currencySelector.val(getDefaultCurrency());
        }
    
        function populateWithFullNames() {
          currencySelector.empty();
          currencies.forEach((currency) => {
            const option = $("<option>")
              .val(currency.code)
              .text(`${currency.name} (${currency.code})`);
            currencySelector.append(option);
          });
          currencySelector.val(getDefaultCurrency());
        }
    
        currencySelector.on("focus", populateWithFullNames);
        currencySelector.on("blur", populateWithSymbols);
        populateWithSymbols();
    
        currencySelector.on("change", function () {
          updateCurrency(this.value);
        });
      });
    </script>   

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const COOKIE_CONSENT_KEY = "cookie_consent";
        const banner = document.getElementById("cookie-consent-banner");
        const acceptButton = document.getElementById("allow-cookies");
        const denyButton = document.getElementById("deny-cookies");
      
        if (!localStorage.getItem(COOKIE_CONSENT_KEY)) {
          banner.style.display = "block";
        }
      
        function applyCookieSettings(consentStatus) {
          if (consentStatus === "allow") {
            loadGoogleAnalytics();
            loadMixpanel();
            mixpanel.opt_in_tracking();
            console.log("Cookies allowed: Analytics enabled.");
          } else {
            mixpanel.opt_out_tracking();
            console.warn("Cookies denied: Analytics disabled.");
          }
        }
      
        function closeBanner() {
          banner.style.display = "none";
        }
      
        acceptButton.addEventListener("click", () => {
          localStorage.setItem(COOKIE_CONSENT_KEY, "allow");
          applyCookieSettings("allow");
          closeBanner();
        });
      
        denyButton.addEventListener("click", () => {
          localStorage.setItem(COOKIE_CONSENT_KEY, "deny");
          applyCookieSettings("deny");
          closeBanner();
        });
      
        const storedConsent = localStorage.getItem(COOKIE_CONSENT_KEY);
        if (storedConsent) {
          applyCookieSettings(storedConsent);
        }
      });
      
      function loadGoogleAnalytics() {
        const script = document.createElement("script");
        script.src = "https://www.googletagmanager.com/gtag/js?id=G-KXVV479GJX";
        script.async = true;
        document.head.appendChild(script);
      
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", "G-KXVV479GJX");
      }
      
      // Function to load Mixpanel dynamically
      function loadMixpanel() {
        mixpanel.init("099a5cb7f4c47e043ee4e55213130e3f", {
          opt_out_tracking_by_default: true,
          ip: false, // Disable geolocation
          property_blacklist: ["$referrer", "$current_url"],
        });
        console.log("Mixpanel initialized with privacy settings.");
      }
      
    </script>
    
    {% block javascript %}{% endblock javascript %}
  </body>
</html>
